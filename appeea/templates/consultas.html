<!-- Autor: Beatriz Flores -->
<!-- Fecha: 03/04/2023 -->

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Facturación</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/js/bootstrap.bundle.min.js" integrity="sha384-qKXV1j0HvMUeCBQ+QVp7JcfGl760yU08IQ+GpUo5hlbpg51QRiuqHAJz8+BrxE/N" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-aFq/bzH65dt+w6FI2ooMVUpc+21e0SRygnTpmBvdBgSdnuTN7QbdgL+OapgHtvPp" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
</head>
    <style>
    #spinner-container {
      display: none;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      background-color: rgba(255, 255, 255, 0.7);
    }
    #spinnerContainer {
      display: none;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      background-color: rgba(255, 255, 255, 0.7);
    }
    </style>
    <script>
      function generarFactura(num_doc) {
            var url = "/obtener_factura/" + num_doc;
            document.getElementById("spinner-container").style.display = "flex";
            setTimeout(function() {
              window.location.href = url;
              document.getElementById("spinner-container").style.display = "none";
            }, 2000);
      }

      function mostrarModal(cuentaContrato) {
        $('#ctacontrato-modal').text(cuentaContrato);
        $('#miModal').on('show.bs.modal', function (event) {
          var select = $(this).find('#anio');
          // Actualizar las opciones del select
          select.html('<option value="2025">2025</option>' +
                      '<option value="2024">2024</option>' +
                      '<option value="2023">2023</option>' +
                      '<option value="2022">2022</option>' +
                      '<option value="2021">2021</option>' +
                      '<option value="2020">2020</option>' +
                      '<option value="2019">2019</option>');
        });
      }

      function mostrarDocumentos(ctaContrato, anio) {
        mostrarModal(ctaContrato);

        document.getElementById("spinnerContainer").style.display = "flex"; // Agrega esta línea para mostrar el spinner

        fetch('/documentos/', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: new URLSearchParams({ ctacontrato: ctaContrato, anio: anio })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("spinnerContainer").style.display = "none"; // Agrega esta línea para ocultar el spinner
            const documentosTable = document.getElementById('documentosTable');
            documentosTable.innerHTML = '';

            if (data.DOCUMENTOS.length === 0) {
              // Si no hay documentos, muestra mensaje
              const row = document.createElement('tr');
              const noResultsCell = document.createElement('td');
              noResultsCell.colSpan = 6; // Agregamos un colspan para que el mensaje ocupe todas las columnas
              noResultsCell.innerText = 'No se encontraron resultados';
              row.appendChild(noResultsCell);
              documentosTable.appendChild(row);
            } else {
            // Si hay documentos, crea las filas de la tabla
            data.DOCUMENTOS.forEach(documento => {
                const row = document.createElement('tr');

                const numDocumento = document.createElement('td');
                numDocumento.innerText = documento.NUMDOCUMENTO;
                row.appendChild(numDocumento);

                const fecDoc = document.createElement('td');
                fecDoc.innerText = documento.FECDOC;
                row.appendChild(fecDoc);

                const numFac = document.createElement('td');
                numFac.innerText = documento.NUMFAC;
                row.appendChild(numFac);

                const fecVen = document.createElement('td');
                fecVen.innerText = documento.FECVEN;
                row.appendChild(fecVen);

                const valorDoc = document.createElement('td');
                valorDoc.innerText = documento.VALORDOC;
                row.appendChild(valorDoc);

                const facturaBtn = document.createElement('button');
                facturaBtn.className = 'btn btn-outline-danger'; // Agregamos las clases de Bootstrap
                facturaBtn.innerHTML = '<i class="bi bi-filetype-pdf"></i>';
                facturaBtn.onclick = () => generarFactura(documento.NUMDOCUMENTO);
                const facturaCell = document.createElement('td');
                facturaCell.appendChild(facturaBtn);
                row.appendChild(facturaCell);

                documentosTable.appendChild(row);
            });
            }
        })
        .catch(error => {
            console.error('Error al obtener los documentos:', error);
        });
    }
    function goBack() {
      window.history.back();
    }

  //--------------------------PRUEBA 1-----------------------------------------------
  let currentPage = 1;  // Página inicial
  let totalRecords = parseInt('{{ details.RESULT_SET.0.TOTAL }}');
  const pageSize = parseInt('{{ details.RESULT_SET.0.PAGE_SIZE }}');

  function updateTable(data) {
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';

      if (data.SERVICIOS) {
          data.SERVICIOS.forEach(servicio => {
              const row = document.createElement('tr');

              row.innerHTML = `
                  <th>
                      <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#miModal" onclick="mostrarDocumentos('${servicio.VKONT}', new Date().getFullYear())">
                          <i class="bi bi-three-dots"></i> Ver más
                      </button>
                  </th>
                  <td>${servicio.VKONT}</td>
                  <td>${servicio.MEDIDOR}</td>
                  <td>${servicio.CUEN}</td>
                  <td>${servicio.DIRECCION}</td>
                  <td>${servicio.DEUDA}</td>
                  <td>${servicio.ESTADOCONTRATO}</td>
                  <td>${servicio.MESES}</td>
              `;
              tableBody.appendChild(row);
          });
      }

      // Actualizar los botones de paginación
      document.getElementById('prevButton').disabled = !data.RESULT_SET || data.RESULT_SET[0].ANTERIOR === 'X';
      document.getElementById('nextButton').disabled = !data.RESULT_SET || data.RESULT_SET[0].SIGUIENTE === 'X';
  }

  function fetchPage(page) {
      if (page < 1) return;
      const skip = (page - 1) * pageSize;
      const data = new URLSearchParams();
      data.append('tipo', 'CEDRUC'); // Ajusta según tus necesidades
      data.append('valor', '0301368387'); // Ajusta según tus necesidades
      data.append('page_size', pageSize);
      data.append('skip', skip);

      fetch('{% url "info_cuenta" %}', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': '{{ csrf_token }}',
              'Accept': 'application/json'
          },
          body: data.toString()
      })
      .then(response => response.json())
      .then(result => {
          if (result.error) {
              console.error('Error:', result.error);
          } else {
              updateTable(result.details);
              //console.dir('ANTERIOR: ',result.details.RESULT_SET[0])
              updatePagination(result.details.RESULT_SET[0]);
              //console.log('Result Details JSON:', JSON.stringify(result.details, null, 2));

              currentPage = page;
          }
      })
      .catch(error => {
          console.error('Error:', error);
      });
  }

  function updatePagination(resultSet) {
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    //console.log('ANT: ',resultSet.ANTERIOR)
    // Deshabilitar o habilitar el botón de "Anterior"
    if (resultSet.ANTERIOR === 'X') {
        prevButton.disabled = false;
        prevButton.onclick = () => fetchPage(currentPage - 1);
    } else {
        prevButton.disabled = true;
    }

    // Deshabilitar o habilitar el botón de "Siguiente"
    if (resultSet.SIGUIENTE === 'X') {
        nextButton.disabled = false;
        nextButton.onclick = () => fetchPage(currentPage + 1);
    } else {
        nextButton.disabled = true;
    }
  }


  function goToPreviousPage() {
      if (currentPage > 1) {
          currentPage--;
          fetchPage(currentPage);
      }
  }

  function goToNextPage() {
      const totalPages = Math.ceil(totalRecords / pageSize);
      if (currentPage < totalPages) {
          currentPage++;
          fetchPage(currentPage);
      }
  }

//---------------------------------------------------------------------------------------------------------------------------------------




  </script>


</head>
<body>
  <br>
  <div class="container-sm">
  {% if error %}
    <div class="alert alert-danger" role="alert">
      {{ error }}
    </div>
    {% endif %}
    </div>
  <div class="container-sm">
    <button type="button" class="btn btn-primary" onclick="goBack()">
      <i class="bi bi-arrow-left"></i>
      Volver
    </button>
  </div>

  <div class="container-sm">
    <br>
    <div class="card">
      <div class="card-body">
        <p><strong>APELLIDOS :  </strong> {{ details.APELLIDOS }}</p>
         <p><strong>NOMBRES :  </strong> {{ details.NOMBRES }}</p>
        <p><strong>CÉDULA/RUC :  </strong> {{ details.CEDRUC }}</p>
        <p><strong>CELULAR :  </strong> {{ details.CELULAR }}</p>
        <p><strong>TELÉFONO :  </strong> {{ details.TELEFONO }}</p>
        <p><strong>EMAIL :  </strong> {{ details.EMAIL }}</p>


      </div>
    </div>
  </div>
  <br>
<div class="container-sm">
  <div class="table-responsive">
  <table class="table">
    <thead>
    <tr>
      <th scope="col"></th>
      <th scope="col">CUENTA CONTRATO</th>
      <th scope="col">MEDIDOR</th>
      <th scope="col">CUENTA</th>
      <th scope="col">DIRECCIÓN</th>
      <th scope="col">DEUDA</th>
      <th scope="col">ESTADO DEL CONTRATO</th>
      <th scope="col">MESES PENDIENTES</th>
    </tr>
  </thead>
  <tbody id="tableBody">
      {% for servicio in details.SERVICIOS %}
    <tr>
      <th>
        <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#miModal" onclick="mostrarDocumentos('{{ servicio.VKONT }}', new Date().getFullYear())">
          <i class="bi bi-three-dots"></i>
          Ver más
        </button>
      </th>
      <td id="ctacontrato-{{ servicio.VKONT }}">{{ servicio.VKONT }}</td>
      <td>{{ servicio.MEDIDOR }}</td>
      <td>{{ servicio.CUEN }}</td>
      <td>{{ servicio.DIRECCION }}</td>
      <td>{{ servicio.DEUDA }}</td>
      <td>{{ servicio.ESTADOCONTRATO }}</td>
      <td>{{ servicio.MESES }}</td>
    </tr>
    {% endfor %}
    {% for result in details.RESULT_SET %}
      {% if result.SIGUIENTE == 'X' %}
          <div class="card-body">
<!--              <p><strong>ANT</strong> {{ result.ANTERIOR }}</p>-->
<!--              <p><strong>SIG</strong> {{ result.SIGUIENTE }}</p>-->
<!--              <p><strong>TOT</strong> {{ result.TOTAL }}</p>-->
<!--              <p><strong>PAGEZ</strong> {{ result.PAGE_SIZE }}</p>-->
<!--              <p><strong>SKIP</strong> {{ result.SKIP }}</p>-->
          </div>
      {% endif %}
    {% endfor %}
  </table>


    <div class="row justify-content-center">
    <div class="col-auto">
      <button type="button" class="btn btn-primary mr-2" id="prevButton" onclick="goToPreviousPage('{{ details.RESULT_SET.0.ANTERIOR }}', '{{ details.RESULT_SET.0.TOTAL }}', '{{ details.RESULT_SET.0.SKIP }}', '{{ details.RESULT_SET.0.PAGE_SIZE }}')">
        <i class="bi bi-arrow-left"></i> Anterior
      </button>
      <button type="button" class="btn btn-primary" id="nextButton" onclick="goToNextPage('{{ details.RESULT_SET.0.SIGUIENTE }}', '{{ details.RESULT_SET.0.TOTAL }}', '{{ details.RESULT_SET.0.SKIP }}', '{{ details.RESULT_SET.0.PAGE_SIZE }}')">
        <i class="bi bi-arrow-right"></i> Siguiente
      </button>
    </div>

<!--      <form method="POST" action="{% url 'info_cuenta' %}">-->
<!--      {% csrf_token %}-->
<!--        <form class="mb-2 row">-->
<!--            <div class="col-sm-6">-->
<!--              <select id="skip" name="skip" class="form-select">-->
<!--                <option value=Skip></option>-->
<!--              </select>-->
<!--            </div>-->
<!--          </form>-->
<!--      </form>-->


<!--    <div class="card-body">-->
<!--        <p><strong>ANT:</strong> {{ item.ANTERIOR }}</p>-->
<!--        <p><strong>SIG:</strong> {{ item.SIGUIENTE }}</p>-->
<!--    </div>-->
  </div>



</div>


</div>

<!-- Modal -->
<div class="modal fade bd-example-modal-lg" id="miModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">DETALLE DEUDA</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="container">
          <div class="row g-4">
            <div class="col">
              <strong>CUENTA CONTRATO <p id="ctacontrato-modal"></p></strong>
            </div>
          </div>
        <div class="row g-3">
          <div class="col-1">
          <label for="anio">AÑO</label>
            </div>
          <div class="col-6">
            <select id="anio" name="anio" class="form-select">
              <option value="2025">2025</option>
              <option value="2024">2024</option>
              <option value="2023">2023</option>
              <option value="2022">2022</option>
              <option value="2021">2021</option>
              <option value="2020">2020</option>
              <option value="2019">2019</option>
            </select>
            </div>
          <div class="col-5">
        <button type="button" class="btn btn-primary" onclick="mostrarDocumentos(document.getElementById('ctacontrato-modal').textContent, document.getElementById('anio').value)">
          <i class="bi bi-search"></i>    Buscar
        </button>
        </div>
        </div>
        </div>
        <br>
        <div class="table-responsive">
          <table class="table">
            <thead>
            <tr>
              <th scope="col">NÚMERO DE DOCUMENTO</th>
              <th scope="col">FECHA DE EMISIÓN</th>
              <th scope="col">NÚMERO DE FACTURA</th>
              <th scope="col">FECHA DE VENCIMIENTO</th>
              <th scope="col">TOTAL CONSUMO</th>
              <th scope="col">PDF</th>
            </tr>
          </thead>
          <tbody id="documentosTable">
          </tbody>
          </table>

          <div id="spinnerContainer">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">Loading...</span>
            </div>
          </div>
          <div id="spinner-container">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">Loading...</span>
            </div>
          </div>

        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">CERRAR</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>
